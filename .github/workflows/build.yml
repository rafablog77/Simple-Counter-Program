
on: [push,workflow_dispatch]

jobs:
 build-linux:
  runs-on: ubuntu-20.04
  steps:
    - uses: sayyid5416/pyinstaller@v1.6.0
      with:
        spec: ./main.py
        options: -F, -w
        exe_path: ./builds
        upload_exe_with_name: linux-build
    - run: shred -u main.spec
    - run: rm -rf build/main
    - uses: peter-evans/create-pull-request@v6
      with:
        commit-message: Update Linux build
        author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
        branch: linux-auto-bulild
        delete-branch: false
        title: Update Linux build
        body: Automated pull request by Github Actions
        labels: build,linux

 clean-artifacts:
  needs: [build-linux]
  if: always()
  runs-on: ubuntu-latest
  steps:
   - name: Delete Artifacts
     env:
      FOR_WEBHOOKS_SECRET: ${{ secrets.FOR_WEBHOOKS_SECRET }}
      run: |
        echo "::add-mask::$FOR_WEBHOOKS_SECRET"
        curl --verbose --fail --show-error --location --request POST "https://api.github.com/repos/$GITHUB_REPOSITORY/dispatches" --header "Authorization: token $FOR_WEBHOOKS_SECRET" --header 'Content-Type: application/json' --header 'Accept: application/vnd.github.everest-preview+json' --data-raw "{ \"event_type\": \"delete_all_artifacts\", \"client_payload\": {\"parent_runid\": \"$GITHUB_RUN_ID\", \"parent_repo\": \"$GITHUB_REPOSITORY\"} }"
        
 build-windows:
  runs-on: windows-latest
  steps:
   - uses: GeekyEggo/delete-artifact@v5
     with:
       name: Generated spec file
       useGlob: false
   - uses: sayyid5416/pyinstaller@v1.6.0
     with:
      spec: ./main.py
      options: -F, -w
      exe_path: ./builds
      upload_exe_with_name: windows-build

   - uses: peter-evans/create-pull-request@v6
     with:
      commit-message: Update Windows build
      author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
      branch: windows-auto-build
      delete-branch: false
      title: Update Windows build
      body: Automated pull request by Github Actions
      labels: build,windows
